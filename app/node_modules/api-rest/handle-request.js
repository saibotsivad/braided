import Trouter from 'trouter'
import { parseUrl } from 'shared/parse-url.js'
import { routes as accountIdRoutes } from 'api-rest/route/[accountId].js'
import { routes as accountIdCollectionNameRoutes } from 'api-rest/route/[accountId]/[collectionName].js'
import { routes as accountIdCollectionNameShardIdRoutes } from 'api-rest/route/[accountId]/[collectionName]/[shardId].js'

const router = new Trouter()

const addRoutes = ({ path, methods }) => {
	for (const method in methods) {
		router.add(method, path, methods[method])
	}
}

addRoutes(accountIdRoutes)
addRoutes(accountIdCollectionNameRoutes)
addRoutes(accountIdCollectionNameShardIdRoutes)

export async function handleRequest(request, service) {
	const url = parseUrl(request.url)

	const { params, handlers } = router.find(request.method, url.pathname)

	if (handlers.length) {
		params.originalUrl = url.origin + url.pathname
		params.lastUpdated = parseInt(url.query.lastUpdated, 10) || 0
		return handlers[0](request, params, service)
	}

	return {
		body: '<p>not found</p>',
		headers: {
			'content-type': 'text/html;charset=UTF-8'
		}
	}
}
