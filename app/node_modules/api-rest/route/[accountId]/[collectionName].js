import { etagIfNoneMatch } from 'shared/etag-if-none-match.js'
import { partition } from 'shared/toolbox.js'

export const routes = {
	path: '/:accountId/:collection',
	methods: {
		GET: async (request, { accountId, collectionName, originalUrl, lastUpdated }, service) => {
			const KeyConditionExpression = lastUpdated
				? 'PrimaryKey = :pk AND SortKey > :sk'
				: 'PrimaryKey = :pk'
			const ExpressionAttributeValues = {
				':pk': {
					S: `${accountId.toUpperCase()}:${collectionName.toUpperCase()}`
				}
			}
			if (lastUpdated) {
				ExpressionAttributeValues[':sk'] = {
					S: lastUpdated.toString()
				}
			}
			const credentials = await service.getCredentials('dynamodb')
			const results = await service.dynamodb(credentials).query({
				TableName: credentials.table,
				KeyConditionExpression,
				ExpressionAttributeValues,
				Limit: 25
			})
			if (!results.Items) {
				return {
					status: 500,
					body: {
						errors: [{
							meta: { results }
						}]
					}
				}
			}
			const { LastEvaluatedKey, Items } = results
			const [ meta, data ] = partition(Items, item => item.PrimaryKey.S === item.GlobalIdentifier.S)

			const collectionMeta = meta && meta[0] && meta[0].JsonData && meta[0].JsonData.S

			const body = {
				data: data.map(item => JSON.parse(item.JsonData.S)),
				meta: {
					collection: collectionMeta && JSON.parse(collectionMeta),
					dynamodb: omit(results, [ 'Items' ])
				}
			}
			if (LastEvaluatedKey) {
				const [ timestamp ] = LastEvaluatedKey.SortKey.S.split(':')
				body.links = {
					next: `${originalUrl}?lastUpdated=${timestamp}` 
				}
			}
			return etagIfNoneMatch(request, body)
		}
	}
}
