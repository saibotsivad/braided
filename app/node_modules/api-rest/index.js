import { handleRequest } from './handle-request.js'
import { service } from './global-services.js'

const work = async (event) => {
	const start = new Date().getTime()
	try {
		let { body, status, headers } = await handleRequest(event.request, service)
		headers = headers || {}
		headers['fanx-app-api-ms'] = (new Date().getTime() - start).toString()
		if (body) {
			headers['content-type'] = 'application/json'
			body = JSON.stringify(body)
		}
		return new Response(body, { headers, status })
	} catch (error) {
		return new Response(JSON.stringify({
			errors: [{
				title: error.name,
				// TODO: leaking the error stack here is a
				// security risk, you might leak credentials
				stack: error.stack
			}]
		}), {
			status: 500,
			headers: { 'content-type': 'application/json' }
		})
	}
}

addEventListener('fetch', event => event.respondWith(work(event)))
