import Trouter from 'trouter'
import { parseUrl } from 'shared/parse-url.js'

import { route as rootRoute } from 'www-root/route/index.js'

const router = new Trouter()

const addRoute = ({ path, methods }) => {
	for (const method in methods) {
		router.add(method, path, methods[method])
	}
}

addRoute(rootRoute)

export async function handleRequest(request, service) {
	const url = parseUrl(request.url)

	const { params, handlers } = router.find(request.method, url.pathname)

	if (handlers.length) {
		params.originalUrl = url.origin + url.pathname
		params.lastUpdated = parseInt(url.query.lastUpdated, 10) || 0
		const { body, headers, status } = await handlers[0](request, params, service)
		return new Response(body, { headers, status })
	}

	return {
		body: '<p>not found</p>',
		headers: {
			'content-type': 'text/html;charset=UTF-8'
		}
	}
}
