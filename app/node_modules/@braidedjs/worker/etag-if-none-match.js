import { hash } from 'shared/service-worker-hash.js'

// Read more about how Cloudflare handles the ETag header:
// https://support.cloudflare.com/hc/en-us/articles/218505467-Using-ETag-Headers-with-Cloudflare
export const etagIfNoneMatch = async (request, body) => {
	const etag = Array.isArray(body.data)
		? await hash(body.data.map(d => d.meta.etag).join(''))
		: body.data.meta.etag

	const ifNoneMatch = request.headers.get('if-none-match')
	const etagsMatch = (ifNoneMatch || '')
		.split(',')
		.map(string => string.trim().replace(/^W\//, '').replace(/"/g, '').trim())
		.includes(etag)

	const headers = { etag: `"${etag}"` }
	return etagsMatch
		? { headers, status: 304 }
		: { headers, status: 200, body }
}
