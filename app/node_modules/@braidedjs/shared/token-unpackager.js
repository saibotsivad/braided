import { ExpiredJwtException } from '@braidedjs/shared/exception/expired-jwt.js'
import { InvalidJwtException } from '@braidedjs/shared/exception/invalid-jwt.js'

const invalidExpiration = (unpacked, currentUnixTime) => {
	return !unpacked.payload
		|| !unpacked.payload.exp
		|| unpacked.payload.exp > currentUnixTime
}

const validateSignature = async (header, payload, signature) => {
	// TODO
}

export const tokenUnpackage = async ({ token, currentUnixTime, base64decode }) => {
	if (typeof token !== 'string' || !token) {
		throw new TypeError('The token must be a JWT string.')
	}

	let parts
	let unpacked
	try {
		parts = token.split('.')
		unpacked = {
			header: JSON.parse(base64decode(parts[0])),
			payload: JSON.parse(base64decode(parts[1])),
			signature: parts[2]
		}
	} catch (error) {
		throw new InvalidJwtException('Provided JWT is malformed and cannot be parsed.')
	}

	if (invalidExpiration(unpacked, currentUnixTime)) {
		throw new ExpiredJwtException('Provided JWT has an expiration date in the past.')
	}

	await validateSignature(...parts)

	return unpacked
}
